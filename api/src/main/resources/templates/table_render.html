<!DOCTYPE html>
<html>
<head>
  <title>ERD View</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f6f9;
    }

    #erd {
      position: relative;
      width: 3000px;
      height: 1600px;
    }

    svg {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }

    .table {
      position: absolute;
      width: 260px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .table-header {
      background: #2f80ed;
      color: white;
      padding: 8px;
      font-weight: bold;
      border-radius: 6px 6px 0 0;
      cursor: move;
      user-select: none;
    }

    .table-header.target {
      background: #27ae60;
    }

    .column {
      padding: 6px 10px;
      font-size: 13px;
      border-top: 1px solid #eee;
    }

    .pk {
      color: #d35400;
      font-weight: bold;
    }

    .fk {
      color: #16a085;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="erd">
  <svg id="lines" width="3000" height="1600"></svg>
</div>

<script>
  const result = JSON.parse(sessionStorage.getItem("dbResult"));
  const erd = document.getElementById("erd");
  const svg = document.getElementById("lines");

  const allTables = [];

  /* =========================
     1Ô∏è‚É£ ÌÖåÏù¥Î∏î Î†åÎçî
  ========================= */
  renderTables(result.sourceTable, "source", 50);
  renderTables(result.targetTable, "target", 1600);

  function renderTables(tables, scope, startX) {
    tables.forEach((table, index) => {
      const div = document.createElement("div");
      div.className = "table";
      div.dataset.table = table.tableName;
      div.dataset.scope = scope;

      div.style.left = (startX + (index % 4) * 300) + "px";
      div.style.top = (50 + Math.floor(index / 4) * 260) + "px";

      const header = document.createElement("div");
      header.className = "table-header " + (scope === "target" ? "target" : "");
      header.textContent = `${scope.toUpperCase()} ¬∑ ${table.tableName}`;
      div.appendChild(header);

      table.columns.forEach(col => {
        const c = document.createElement("div");
        c.className = "column";
        c.id = `${scope}.${table.tableName}.${col.name}`;

        let text = `${col.name} : ${col.type}`;

        if (table.primaryKeys.some(pk => pk.columnName === col.name)) {
          c.classList.add("pk");
          text = "üîë " + text;
        }

        if (table.foreignKeys.some(fk => fk.fkColumn === col.name)) {
          c.classList.add("fk");
          text = "üîó " + text;
        }

        c.textContent = text;
        div.appendChild(c);
      });

      erd.appendChild(div);
      allTables.push({ ...table, scope });
    });
  }

  /* =========================
     2Ô∏è‚É£ SVG ÌôîÏÇ¥Ìëú
  ========================= */
  function initSvg() {
    svg.innerHTML = `
      <defs>
        <marker id="arrow" markerWidth="10" markerHeight="10"
          refX="10" refY="3" orient="auto">
          <path d="M0,0 L0,6 L9,3 z" fill="#555"/>
        </marker>
      </defs>
    `;
  }

  function drawLine(fromEl, toEl) {
    const f = fromEl.getBoundingClientRect();
    const t = toEl.getBoundingClientRect();

    const x1 = f.right;
    const y1 = f.top + f.height / 2 + window.scrollY;
    const x2 = t.left;
    const y2 = t.top + t.height / 2 + window.scrollY;

    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", x1);
    line.setAttribute("y1", y1);
    line.setAttribute("x2", x2);
    line.setAttribute("y2", y2);
    line.setAttribute("stroke", "#555");
    line.setAttribute("stroke-width", "1.5");
    line.setAttribute("marker-end", "url(#arrow)");

    svg.appendChild(line);
  }

  function redrawLines() {
    initSvg();

    allTables.forEach(table => {
      table.foreignKeys.forEach(fk => {
        const from = document.getElementById(
                `${table.scope}.${table.tableName}.${fk.fkColumn}`
        );
        const to = document.getElementById(
                `${table.scope}.${fk.pkTable}.${fk.pkColumn}`
        );
        if (from && to) drawLine(from, to);
      });
    });
  }

  setTimeout(redrawLines, 150);

  /* =========================
     3Ô∏è‚É£ ÎìúÎûòÍ∑∏ & ÎìúÎ°≠
  ========================= */
  let dragging = null;
  let offsetX = 0;
  let offsetY = 0;

  document.addEventListener("mousedown", e => {
    const header = e.target.closest(".table-header");
    if (!header) return;

    dragging = header.parentElement;
    const rect = dragging.getBoundingClientRect();

    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;

    dragging.style.zIndex = 1000;
  });

  document.addEventListener("mousemove", e => {
    if (!dragging) return;

    dragging.style.left = (e.pageX - offsetX) + "px";
    dragging.style.top = (e.pageY - offsetY) + "px";

    redrawLines();
  });

  document.addEventListener("mouseup", () => {
    if (dragging) dragging.style.zIndex = 1;
    dragging = null;
  });
</script>

</body>
</html>