<!DOCTYPE html>
<html>
<head>
  <title>ERD View</title>
  <style>
    body {
      height: 100vh;
      width: 100%;
      margin: 0 auto;
      display: flex;              /* Flexbox ì‚¬ìš© */
      flex-direction: column;     /* ì„¸ë¡œë¡œ ìŒ“ê¸° */
      justify-content: center;    /* ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
      align-items: center;        /* ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
      font-family: Arial, sans-serif;
      background: #f4f6f9;
    }

    /* ìƒë‹¨ ë²„íŠ¼ ì˜ì—­ ê³ ì • */
    #top-bar {
      padding: 10px;
      background: #2f80ed;
      width: 100%;
      color: white;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      flex-shrink: 0;
    }

    #nextStep {
      background: white;
      color: #2f80ed;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    /* ERDë§Œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
    #erd-container {
      flex: 1;           /* ìƒë‹¨ ì œì™¸í•œ ì˜ì—­ ì „ì²´ */
      overflow: auto;    /* ê°€ë¡œ/ì„¸ë¡œ ìŠ¤í¬ë¡¤ */
      background: #eeeeee;
      width: 80%;
      height: 80%;

    }

    #erd {
      position: relative;
    }

    svg {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }

    .table {
      position: absolute;
      width: 260px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .table-header {
      background: #2f80ed;
      color: white;
      padding: 8px;
      font-weight: bold;
      border-radius: 6px 6px 0 0;
      cursor: move;
      user-select: none;
    }

    .table-header.target {
      background: #27ae60;
    }

    .column {
      padding: 6px 10px;
      font-size: 13px;
      border-top: 1px solid #eee;
    }

    .pk {
      color: #d35400;
      font-weight: bold;
    }

    .fk {
      color: #16a085;
      font-weight: bold;
    }
  </style>
</head>
<body>

<!-- ìƒë‹¨ ë²„íŠ¼ ê³ ì • -->
<div id="top-bar">
  <button id="nextStep">ë‹¤ìŒ ìŠ¤í…</button>
</div>

<!-- ERDë§Œ ìŠ¤í¬ë¡¤ -->
<div id="erd-container">
  <div id="erd">
    <svg id="lines" width="3000" height="1600"></svg>
  </div>
</div>

<script>
  const result = JSON.parse(sessionStorage.getItem("dbResult"));
  const erd = document.getElementById("erd");
  const svg = document.getElementById("lines");

  const allTables = [];

  renderTables(result.sourceTable, "source", 50, 50);
  renderTables(result.targetTable, "target", 50, 300);

  function renderTables(tables, scope, startX, startY) {
    tables.forEach((table, index) => {
      const div = document.createElement("div");
      div.className = "table";
      div.dataset.table = table.tableName;
      div.dataset.scope = scope;

      div.style.left = (startX + (index % 4) * 300) + "px";
      div.style.top = (startY + Math.floor(index / 4) * 260) + "px";

      const header = document.createElement("div");
      header.className = "table-header " + (scope === "target" ? "target" : "");
      header.textContent = `${scope.toUpperCase()} Â· ${table.tableName}`;
      div.appendChild(header);

      table.columns.forEach(col => {
        const c = document.createElement("div");
        c.className = "column";
        c.id = `${scope}.${table.tableName}.${col.name}`;

        let text = `${col.name} : ${col.type}`;
        if (table.primaryKeys.some(pk => pk.columnName === col.name)) {
          c.classList.add("pk");
          text = "ğŸ”‘ " + text;
        }
        if (table.foreignKeys.some(fk => fk.fkColumn === col.name)) {
          c.classList.add("fk");
          text = "ğŸ”— " + text;
        }
        c.textContent = text;
        div.appendChild(c);
      });

      erd.appendChild(div);
      allTables.push({ ...table, scope });
    });
  }

  function initSvg() {
    svg.innerHTML = `
      <defs>
        <marker id="arrow" markerWidth="10" markerHeight="10"
          refX="10" refY="3" orient="auto">
          <path d="M0,0 L0,6 L9,3 z" fill="#555"/>
        </marker>
      </defs>
    `;
  }

  function drawLine(fromEl, toEl) {
    const f = fromEl.getBoundingClientRect();
    const t = toEl.getBoundingClientRect();
    const containerRect = document.getElementById("erd-container").getBoundingClientRect();

    const x1 = f.right - containerRect.left + document.getElementById("erd-container").scrollLeft;
    const y1 = f.top - containerRect.top + f.height / 2 + document.getElementById("erd-container").scrollTop;
    const x2 = t.left - containerRect.left + document.getElementById("erd-container").scrollLeft;
    const y2 = t.top - containerRect.top + t.height / 2 + document.getElementById("erd-container").scrollTop;

    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", x1);
    line.setAttribute("y1", y1);
    line.setAttribute("x2", x2);
    line.setAttribute("y2", y2);
    line.setAttribute("stroke", "#555");
    line.setAttribute("stroke-width", "1.5");
    line.setAttribute("marker-end", "url(#arrow)");

    svg.appendChild(line);
  }

  function redrawLines() {
    initSvg();
    allTables.forEach(table => {
      table.foreignKeys.forEach(fk => {
        const from = document.getElementById(`${table.scope}.${table.tableName}.${fk.fkColumn}`);
        const to = document.getElementById(`${table.scope}.${fk.pkTable}.${fk.pkColumn}`);
        if (from && to) drawLine(from, to);
      });
    });
  }

  setTimeout(redrawLines, 150);

  /* ë“œë˜ê·¸ & ë“œë¡­ */
  let dragging = null;
  let offsetX = 0;
  let offsetY = 0;

  document.addEventListener("mousedown", e => {
    const header = e.target.closest(".table-header");
    if (!header) return;

    dragging = header.parentElement;
    const rect = dragging.getBoundingClientRect();

    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;

    dragging.style.zIndex = 1000;
  });

  document.addEventListener("mousemove", e => {
    if (!dragging) return;
    dragging.style.left = (e.pageX - offsetX) + "px";
    dragging.style.top = (e.pageY - offsetY) + "px";
    redrawLines();
  });

  document.addEventListener("mouseup", () => {
    if (dragging) dragging.style.zIndex = 1;
    dragging = null;
  });

  /* ë‹¤ìŒ ìŠ¤í… ë²„íŠ¼ */
  document.getElementById("nextStep").addEventListener("click", () => {
    alert("ë‹¤ìŒ ë‹¨ê³„: DB ë¹„êµ í™”ë©´ìœ¼ë¡œ ì´ë™");
    // window.location.href = 'db_compare.html';
  });
</script>

</body>
</html>